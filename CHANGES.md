# 修改记录

## 2025-03-02

### 删除代理合约相关代码

- 从`monitor.py`中删除了`monitor_proxy_events`和`handle_upgrade_event`方法
- 从`monitor.py`的`run`方法中移除了`monitor_proxy_events`任务
- 从`monitor.py`的`initialize`方法中移除了获取管理员地址的代码
- 从`monitor.py`的`check_contract_state`方法中移除了检查管理员地址的代码
- 在`contract.py`中添加了`get_implementation_address`方法
- 从`state.py`中移除了`current_admin`属性和`update_admin`方法
- 从`settings.py`中移除了`PROXY_ADDRESS`和`PROXY_ABI`配置

### 删除测试相关代码

- 删除了`test_rpc.py`文件
- 删除了`test_basic_rpc.py`文件
- 更新了`README.md`文件，移除了关于测试的部分

### 改进事件监控功能

- 优化了事件过滤器的创建方式，使其更适合SEI链
- 添加了`create_event_filter`方法，为每种事件类型创建专用过滤器
- 添加了`get_all_events`方法，获取多种事件类型的事件
- 对事件过滤器添加了区块范围限制，避免请求过大
- 增强了错误处理和日志记录，提高系统稳定性
- 保留了基本日志解析功能作为备用，处理特殊情况
- 修复了异步Web3环境中事件过滤器的创建和使用问题
- 正确实现了事件过滤器的创建和日志获取流程，提高了事件监控的可靠性
- 优化了事件解析逻辑，正确处理各种类型的事件
- 聚焦关键资金安全事件，只监控'Supply', 'Withdraw', 'Borrow', 'Repay', 'LiquidationCall', 'FlashLoan'
- 增强了基本日志解析能力，从topics中提取更多信息
- 减少非关键事件的日志记录，提高系统效率和日志可读性

### 澄清代理合约和实现合约的事件监听

- 更新了`contract.py`中的变量命名，将`self.implementation`改为`self.contract`，使代码更清晰
- 添加了详细注释，说明在可升级代理模式中，事件从代理合约地址发出，但使用实现合约的ABI解析
- 更新了`monitor.py`中的方法名称和注释，使其与`contract.py`保持一致
- 确保所有事件监听都针对代理合约地址，但使用实现合约的ABI进行解析

### 改进日志解析功能

- 添加了更详细的日志调试信息，打印原始日志内容和解析尝试过程
- 添加了`basic_decode_log`方法，当标准解析失败时，尝试从topics中提取基本事件信息
- 更新了`handle_implementation_event`方法，支持处理基本解析的事件
- 添加了常见事件签名的映射，用于识别无法通过ABI解析的事件
- 增强了错误处理和日志记录，提供更多调试信息

### 其他改进

- 创建了`README.md`文件，说明项目的用途、安装和使用方法
- 创建了`CHANGES.md`文件，记录修改历史
- 测试了修改后的代码，成功捕获并处理了事件
- 解决了Windows环境下的兼容性问题

## 2025-03-03

### 安全事件监控优化

- 将事件监控聚焦在与资金安全相关的关键事件上
- 优化了事件过滤器逻辑，减少无关事件带来的解析错误
- 增强了基本日志解析功能，可以从topics中提取地址信息
- 降低了非关键事件的日志级别，避免日志过于冗长

### 通知系统优化

- 优化了Bark通知的内容格式，对消息内容进行URL编码，确保换行符正确显示
- 添加了金额单位转换功能，将链上原始金额转换为更易读的格式
- 为常见代币(USDC, USDT, DAI, WETH等)添加了精度和符号信息
- 事件消息中展示的金额更易读，包含代币符号和适当精度

### 借款利率格式化

- 添加了`format_interest_rate`函数，将链上借款利率数据转换为百分比形式
- 自动识别RAY格式(10^27)和WAD格式(10^18)的利率数据
- 借款事件中的利率显示更加直观，例如"1.9%"而非原始的大数值

### 资产显示优化

- 添加了`get_token_name`函数，用于从合约地址获取代币名称
- 将事件消息中的合约地址替换为易读的代币符号(如USDC、USDT等)
- 对于未知代币，显示缩短的合约地址，增强可读性
- 清算事件中同时优化了抵押品和债务资产的显示

### 动态代币信息获取

- 添加了从合约动态获取支持的代币列表的功能
- 通过`getReservesList`接口获取所有支持的代币合约地址
- 使用ERC20标准接口动态获取每个代币的名称和精度信息
- 在监控系统初始化时自动获取并更新TOKEN_DECIMALS字典
- 提高了系统的适应性，无需手动维护代币列表
- 对于调用失败的代币，保留基本的错误处理和默认值机制

## 2025-03-05

### 流动性监控功能

- 添加了资金池流动性监控功能，当资金变动时自动检查流动性状况
- 实现了`get_reserve_data`、`get_asset_liquidity`和`get_pool_liquidity`方法，用于获取资产和资金池的流动性信息
- 在Config类中添加了流动性警戒线配置参数：
  - `UTILIZATION_WARNING_THRESHOLD`: 整体利用率警戒线（默认80%）
  - `ASSET_UTILIZATION_WARNING_THRESHOLD`: 单一资产利用率警戒线（默认85%）
  - `LIQUIDITY_CHANGE_THRESHOLD`: 流动性变化阈值（默认10%）
- 在`YEIMonitor`类中添加了流动性状态追踪和变化检测
- 对资金变动事件（存款、提款、借款、还款、清算）添加了流动性检查逻辑
- 流动性警报分为三种情况：
  - 当单一资产利用率达到警戒线时发送警报
  - 当整体资金池利用率达到警戒线时发送警报
  - 当资产利用率变化超过阈值时发送警报
- 优化了事件处理逻辑，将消息构建和流动性检查分离，提高代码可维护性

### 下一步计划

- 添加资金池健康度评估功能
- 实现定期检查资金池状态的功能
- 增加更多流动性指标的监控
- 添加重点用户的流动性风险监控
- 实现流动性数据的历史记录和趋势分析

## 2025-03-06

### 其他改进

- 继续扩展TOKEN_DECIMALS字典，添加更多代币信息
- 考虑接入链上代币信息API，动态获取未知代币的名称和精度

## 2025-03-07

### 流动性变化指示器增强

- 改进Bark通知消息格式，添加了流动性变化指示器
- 使用"+"和"-"符号直观表示流动性增加和减少
- 为资产利用率预警添加剩余流动性百分比字段
- 为整体资金池利用率预警添加剩余流动性显示
- 优化日志输出格式，包含更多流动性相关信息
- 改进流动性状态的可视化表示，使预警信息更易理解

## 2025-03-08

### 智能通知系统

- 增加了`NOTIFY_ALL_EVENTS`配置选项，默认设置为`False`
- 优化通知策略：默认情况下只发送关键安全警报，减少通知噪音
- 智能区分普通事件和关键安全事件：
  - 普通资金事件（存款、提款、借款、还款）默认只记录日志，不发送通知
  - 流动性变化超过阈值时发送警报通知
  - 高风险事件（清算、闪电贷）始终发送通知
- 提高了系统的可配置性，用户可根据需要启用所有事件通知
- 改进了日志记录，增加更详细的事件处理信息，便于追踪和审计
- 优化了代码结构，使通知逻辑更清晰和可维护

## 2025-03-09

### 修复流动性监控问题

- 修复了`getReserveData`返回字段解析错误
- 根据YEI智能合约的实际返回结构调整字段映射，特别是`id`和token地址的顺序
- 增加了对`accruedToTreasury`、`unbacked`和`isolationModeTotalDebt`字段的处理
- 增强了调试日志记录，记录原始返回数据结构
- 提高了流动性数据获取的可靠性，确保资产利用率计算准确
- 优化了异常处理，提供更详细的错误信息

### 优化ABI管理结构

- 将完整的`aToken` ABI移动到`settings.py`配置文件中集中管理
- 从其他需要的位置导入ABI，保持代码结构清晰
- 移除了`contract.py`中的冗余ABI定义
- 优化了ABI导入路径
- 使用更完整的`aToken` ABI支持更多合约功能
- 修复了ABI导入路径错误问题，从Config类属性正确访问ATOKEN_ABI

### 增强合约调用容错能力

- 增强了`totalSupply`函数调用的容错能力，解决在某些情况下ABI函数找不到的问题
- 增加了三级调用策略：标准ABI调用 -> 简化ABI调用 -> 原始方法调用
- 为不同类型的代币合约（aToken、债务代币）添加了更健壮的调用方法
- 添加了详细的调试日志，帮助识别和解决合约调用问题
- 改进了合约ABI验证机制，确保函数存在于ABI中
- 优化了异常处理，在一种调用方式失败时尝试备用方法 